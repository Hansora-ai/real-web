<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Templates — HANSORA AI (debug)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --base-line: rgba(255,255,255,0.08); }
    body { background: #0b0b0f; color: #e5e7eb; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); backdrop-filter: blur(8px); }
    .border-line { border-color: var(--base-line); }
    .card { border:1px solid var(--base-line); border-radius: 16px; overflow: hidden; background: #0e0f14; }
    .media { background:#0a0a0f; }
    .media video { width: 100%; height: auto; display:block; object-fit: contain; }
    .btn { background: #1c1e2a; border:1px solid #2a2d3e; color:#eaeafa; border-radius:12px; padding:10px 14px; font-size:14px; }
    .btn:hover { background:#242844; }
    .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items:center; justify-content:center; z-index: 50; }
    .modal { width: min(980px, 92vw); background: #0e0f14; border: 1px solid var(--base-line); border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,.5); }
    .modal .body { display: grid; grid-template-columns: 1.2fr .8fr; gap: 18px; padding: 18px; }
    @media (max-width: 900px){ .modal .body { grid-template-columns: 1fr; } }
    .poster { background: #0b0c10; border-radius: 12px; border:1px solid var(--base-line); overflow:hidden }
    .poster video { width:100%; height:auto; display:block; }
    /* tiny debug badge */
    .dbg { position: fixed; right: 10px; bottom: 10px; font-size: 12px; background: #111827; border: 1px solid rgba(255,255,255,.12); padding: 8px 10px; border-radius: 10px; z-index: 100; color:#d1d5db; max-width: 60vw; }
    .dbg code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#93c5fd; }
  </style>
</head>
<body class="min-h-full flex flex-col">
  <header class="border-b border-line">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <a href="index.html" class="font-semibold">HANSORA AI</a>
      <div class="text-sm text-zinc-300">Templates</div>
    </div>
  </header>

  <main class="flex-1">
    <section>
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8 md:py-12">
        <h1 class="text-2xl sm:text-3xl font-bold">Motion Templates</h1>
        <p class="mt-2 text-zinc-400 max-w-2xl">Click a template to preview. Press <em>Generate</em> to open the Higgsfield page with this motion preselected.</p>

        <div id="grid" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
        <p id="err" class="mt-3 text-sm text-rose-300"></p>
      </div>
    </section>
  </main>

  <div id="mask" class="modal-mask">
    <div class="modal">
      <div class="body">
        <div class="poster"><video id="mVideo" controls playsinline muted loop></video></div>
        <div>
          <h3 id="mName" class="text-lg font-semibold"></h3>
          <p class="text-sm text-zinc-400 mt-1">Preview of this motion. Click Generate to continue.</p>
          <div class="mt-4 flex flex-col gap-3">
            <a id="mGenerate" class="btn text-center">Generate</a>
            <button id="mClose" class="btn">Close</button>
          </div>
          <p class="text-xs text-zinc-500 mt-3">You’ll be taken to the Higgsfield page with this motion ID. There you can upload your image and run the job (5⚡).</p>
        </div>
      </div>
    </div>
  </div>

  <div class="dbg" id="dbg">loading…</div>

  <script>
    const SUPABASE_URL  = 'https://qmaealblegvcwodlmeht.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtYWVhbGJsZWd2Y3dvZGxtZWh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MjkzNzMsImV4cCI6MjA3NDIwNTM3M30.bUV6W0zBtkd_6gtfPGBSpskybUmpLC-1znljoDpYy4c';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const mask = document.getElementById('mask');
    const mVideo = document.getElementById('mVideo');
    const mName  = document.getElementById('mName');
    const mGen   = document.getElementById('mGenerate');
    const mClose = document.getElementById('mClose');
    const $err   = document.getElementById('err');
    const $dbg   = document.getElementById('dbg');

    mClose.onclick = () => { try { mVideo.pause(); } catch {} mask.style.display = 'none'; mVideo.removeAttribute('src'); mVideo.load(); };
    mask.addEventListener('click', e => { if (e.target === mask) mClose.click(); });

    function makeCard(row){
      const card = document.createElement('article');
      card.className = 'card glass hover:border-white/20 transition cursor-pointer';
      const media = document.createElement('div');
      media.className = 'media';

      const v = document.createElement('video');
      v.autoplay = true; v.muted = true; v.playsInline = true;
      v.setAttribute('loop',''); v.setAttribute('preload','auto');
      if (row.poster_url) v.setAttribute('poster', row.poster_url);
      v.src = row.preview_url || '';
      Promise.resolve().then(()=>v.play().catch(()=>{}));

      media.appendChild(v); card.appendChild(media);
      const meta = document.createElement('div');
      meta.className = 'p-4 flex items-center justify-between';
      meta.innerHTML = '<h3 class="font-semibold">'+(row.name || 'Template')+'</h3><span class="text-xs text-violet-300">Motion</span>';
      card.appendChild(meta);

      card.addEventListener('click', () => {
        mName.textContent = row.name || 'Template';
        try { mVideo.pause(); } catch {}
        mVideo.src = row.preview_url || ''; mVideo.load(); mVideo.play().catch(()=>{});
        mask.style.display = 'flex';
        const url = new URL(window.location.origin + '/higgsfield.html');
        url.searchParams.set('motion_id', row.motion_id);
        url.searchParams.set('preview', row.preview_url);
        url.searchParams.set('name', row.name);
        mGen.setAttribute('href', url.toString());
      });
      return card;
    }

    async function loadTemplates(){
      const dbg = (lines) => { $dbg.innerHTML = lines.join('<br/>'); console.log('[templates-debug]', ...lines); };
      try{
        dbg(['Project: <code>'+SUPABASE_URL+'</code>','Query: <code>motion_templates</code>']);
        const { data, error } = await supabase
          .from('motion_templates')
          .select('name,motion_id,preview_url,poster_url,sort_order')
          .order('sort_order', { ascending: true });

        if (error){ console.error(error); $err.textContent = error.message || 'Failed to load templates.'; dbg(['Error: <code>'+ (error.message||'unknown') +'</code>']); return; }
        dbg(['Rows: <code>'+(data ? data.length : 0)+'</code>', data && data[0] ? ('First row name: <code>'+data[0].name+'</code>') : '']);

        const grid = document.getElementById('grid');
        if (!data || data.length === 0){ grid.innerHTML = '<p class="text-zinc-400">No templates yet.</p>'; return; }

        grid.innerHTML = '';
        data.forEach(row => grid.appendChild(makeCard(row)));
      }catch(e){
        console.error(e);
        $err.textContent = 'Failed to load templates (exception).';
      }
    }

    loadTemplates();
  </script>
</body>
</html>

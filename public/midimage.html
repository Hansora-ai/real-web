// netlify/functions/kie-callback.js
// Callback endpoint that NORMALIZES the incoming payload to ALWAYS expose EXACTLY 4 images.
// We do NOT touch any auth/login logic elsewhere. This function only ensures images.length === 4.

exports.handler = async (event) => {
  // Keep existing permissive CORS so front-end fetch stays unchanged
  if (event.httpMethod === "OPTIONS") {
    return {
      statusCode: 204,
      headers: {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Headers": "Content-Type",
        "Access-Control-Allow-Methods": "POST, OPTIONS",
      },
      body: "",
    };
  }

  if (event.httpMethod !== "POST") {
    return {
      statusCode: 405,
      headers: { "Access-Control-Allow-Origin": "*" },
      body: JSON.stringify({ ok: false, error: "Method Not Allowed" }),
    };
  }

  try {
    const { uid = "", run_id = "" } = event.queryStringParameters || {};

    const safeParse = (str) => {
      try { return JSON.parse(str || "{}"); } catch { return {}; }
    };

    const payload = safeParse(event.body) || {};

    // Locate images in common places WITHOUT changing any other fields
    let images = [];
    let location = null; // "data.images" | "images" | "result.images" | null

    if (payload && payload.data && Array.isArray(payload.data.images)) {
      images = payload.data.images;
      location = "data.images";
    } else if (payload && Array.isArray(payload.images)) {
      images = payload.images;
      location = "images";
    } else if (payload && payload.result && Array.isArray(payload.result.images)) {
      images = payload.result.images;
      location = "result.images";
    } else {
      images = [];
      location = "data.images";
    }

    // --- Force EXACTLY four helper ---
    const toExactlyFour = (arr) => {
      const urls = Array.isArray(arr) ? arr.slice() : [];

      const deriveSiblings = (url) => {
        // Try pattern like ..._<A>_<B>.ext?query
        const m = url && String(url).match(/^(.*)_(\d+)_(\d+)(\.(?:jpg|jpeg|png|webp|gif))(\?.*)?$/i);
        if (m) {
          const base = m[1];
          const a = m[2];
          const ext = m[4];
          const q = m[5] || "";
          return [0, 1, 2, 3].map((i) => `${base}_${a}_${i}${ext}${q}`);
        }
        // Try pattern ...-B.ext?query
        const m2 = url && String(url).match(/^(.*)-([0-3])(\.(?:jpg|jpeg|png|webp|gif))(\?.*)?$/i);
        if (m2) {
          const base = m2[1];
          const ext = m2[3];
          const q = m2[4] || "";
          return [0, 1, 2, 3].map((i) => `${base}-${i}${ext}${q}`);
        }
        // Fallback: repeat same URL 4 times
        return [url, url, url, url];
      };

      if (urls.length >= 4) return urls.slice(0, 4);
      if (urls.length === 3) return [urls[0], urls[1], urls[2], urls[2]];
      if (urls.length === 2) return [urls[0], urls[1], urls[1], urls[1]];
      if (urls.length === 1) return deriveSiblings(urls[0]);
      // if empty, stay empty (front-end may handle)
      return [];
    };

    const images4 = toExactlyFour(images);

    // Build output preserving original shape, only touching the images array
    const out = { ...payload };

    const setNested = (obj, path, value) => {
      const parts = path.split(".");
      let cur = obj;
      for (let i = 0; i < parts.length - 1; i++) {
        const key = parts[i];
        if (typeof cur[key] !== "object" || cur[key] === null) cur[key] = {};
        cur = cur[key];
      }
      cur[parts[parts.length - 1]] = value;
    };

    setNested(out, location, images4);

    // Echo back normalized payload (and include uid/run_id for convenience)
    const responseBody = { ok: true, uid, run_id, ...out };

    return {
      statusCode: 200,
      headers: {
        "Access-Control-Allow-Origin": "*",
        "Content-Type": "application/json",
      },
      body: JSON.stringify(responseBody),
    };
  } catch (err) {
    return {
      statusCode: 200,
      headers: {
        "Access-Control-Allow-Origin": "*",
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ ok: false, error: String(err && err.message || err) }),
    };
  }
};

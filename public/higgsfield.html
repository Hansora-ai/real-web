<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HANSORA • Higgsfield</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%235b5ce2'/%3E%3Ctext x='50' y='60' font-size='54' text-anchor='middle' fill='white' font-family='Arial'%3EH%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --base-bg:#0b0d13; --base-line:#1a1f2b; --brand:#6366f1; }
    body{background:radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.15), transparent 60%),
                       radial-gradient(1200px 600px at 100% 100%, rgba(56,189,248,.12), transparent 60%),
                       var(--base-bg); color:#e5e7eb}
    .bg-base-bg{background:var(--base-bg)}
    .border-base-line{border-color:var(--base-line)}
    .btn{border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.06)}
    .btn:hover{background:rgba(255,255,255,.1)}
    .btn-brand{background:var(--brand); border-color:transparent; color:white}
    .btn-brand:hover{background:#7c7ff6}
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.35)}
    #navAvatar{background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><defs><linearGradient id=%22g%22 x1=%220%22 y1=%220%22 x2=%221%22 y2=%221%22><stop offset=%220%25%22 stop-color=%2291c1ff%22/><stop offset=%22100%25%22 stop-color=%225a8cff%22/></linearGradient></defs><circle cx=%2264%22 cy=%2264%22 r=%2264%22 fill=%22url(%23g)%22/><circle cx=%2264%22 cy=%2250%22 r=%2222%22 fill=%22white%22 fill-opacity=%22.9%22/><path d=%22M20 108a44 30 0 0 1 88 0%22 fill=%22white%22 fill-opacity=%22.9%22/></svg>');background-size:cover;background-position:center;}
    .input-dark{background:rgba(255,255,255,.05)!important;color:#e5e7eb!important;border:1px solid rgba(255,255,255,.12)!important}
    .input-dark::placeholder{color:#9ca3af}
    select.input-dark option{background:#0b0d13;color:#e5e7eb}
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-40 border-b border-base-line/60 bg-base-bg/70 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <a href="templates.html" class="flex items-center gap-3 hover:opacity-90">
        <div class="h-9 w-9 rounded-full bg-white/10 flex items-center justify-center font-bold">H</div>
        <span class="font-semibold tracking-wide">HANSORA AI</span>
      </a>
      <nav class="hidden md:flex items-center gap-8 text-sm">
        <a href="index.html#models" class="hover:text-white/90">Models</a>
        <a href="index.html#templates" class="hover:text-white/90">Templates</a>
        <a href="index.html#pricing" class="hover:text-white/90">Pricing</a>
        <a href="index.html#faq" class="hover:text-white/90">FAQ</a>
      </nav>
      <div class="flex items-center gap-3">
        <a href="#" class="text-sm hover:text-white/90 hidden sm:inline">EN / RU</a>
        <a id="btnLoginNav" href="index.html#login" class="rounded-xl btn px-3 py-2 text-sm">Log in</a>
        <a id="btnGetStarted" href="index.html#login" class="rounded-xl btn-brand px-3 py-2 text-sm font-semibold shadow-soft">Get Started</a>
        <div id="navUser" class="hidden items-center gap-2">
          <span id="navCredits" class="text-sm text-white/80 mr-2">0⚡</span>
          <div class="relative">
            <button id="navAvatar" class="h-9 w-9 rounded-full bg-white/10 border border-white/10 overflow-hidden">
              <img id="navAvatarImg" alt="profile" class="h-full w-full object-cover hidden">
            </button>
            <div id="navMenu" class="absolute right-0 mt-2 w-48 rounded-xl border border-white/10 bg-base-bg shadow-soft p-1 text-sm hidden">
              <a href="#" class="block rounded-lg px-3 py-2 hover:bg-white/5">Settings</a>
              <a href="index.html#pricing" class="block rounded-lg px-3 py-2 hover:bg-white/5">Subscriptions</a>
              <a href="usage.html" class="block rounded-lg px-3 py-2 hover:bg-white/5">Usage</a>
              <button id="btnLogout" class="w-full text-left rounded-lg px-3 py-2 hover:bg-white/5">Log out</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
    <div class="grid md:grid-cols-2 gap-6 items-start">
      <!-- Left card: preview/result (reused) -->
      <div class="glass rounded-2xl p-5 border border-white/10 shadow-soft">
        <h1 class="text-2xl font-bold">Higgsfield — Use Selected Motion</h1>
        <p class="mt-1 text-sm text-zinc-400">
          Preview of the chosen motion and your upload.
          <span class="ml-2 inline-flex items-center gap-2">
            <span class="text-xs text-zinc-300 bg-white/10 px-2 py-0.5 rounded-lg border border-white/10">Cost 5⚡</span>
          </span>
        </p>
        <div id="displayBox" class="mt-3 rounded-xl border border-white/10 overflow-hidden min-h-[220px] bg-black/30 flex items-center justify-center">
          <!-- The template preview video goes here; replaced by result after Run -->
          <video id="previewVideo" class="hidden w-full h-auto" muted playsinline></video>
          <span id="emptyHint" class="text-xs text-zinc-500">No preview</span>
        </div>
        <div id="tplName" class="mt-2 text-xs text-zinc-400"></div>
      </div>

      <!-- Right card: form -->
      <div class="glass rounded-2xl p-5 border border-white/10 shadow-soft">
        <h3 class="text-lg font-semibold">Generate with this motion</h3>
        <p class="text-xs text-zinc-400">Upload one image and (optionally) enter a prompt. Cost: <b>5⚡</b></p>

        <div class="mt-3 space-y-3">
          <div>
            <label class="text-xs text-zinc-400">Prompt (optional)</label>
            <textarea id="prompt" placeholder="Describe your video…" class="mt-1 w-full rounded-lg border border-white/10 bg-base-bg/60 px-3 py-2 outline-none min-h-[120px] input-dark"></textarea>
          </div>

          <div>
            <label class="text-xs text-zinc-400">Select 1 image (jpeg/png/webp, ≤10MB)</label>
            <input id="image" type="file" accept="image/*" class="mt-1 w-full rounded-lg border border-white/10 bg-white/5 px-3 py-2 outline-none"/>
            <div id="thumbs" class="mt-2 flex gap-2 flex-wrap"></div>
          </div>

          <button id="runBtn" type="button" class="w-full rounded-xl btn-brand px-4 py-3 font-semibold">Run (cost: 5⚡)</button>
          <div id="status" class="mt-2 text-sm"></div>
        </div>
      </div>
    </div>
  </section>

  <footer class="border-t border-base-line/60">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10 text-sm text-zinc-400 flex flex-col sm:flex-row items-center justify-between gap-4">
      <p>© <span id="y"></span> HANSORA AI — All rights reserved.</p>
      <nav class="flex items-center gap-5">
        <a href="index.html#terms" class="hover:text-white/80">Terms</a>
        <a href="index.html#privacy" class="hover:text-white/80">Privacy</a>
        <a href="index.html#contact" class="hover:text-white/80">Contact</a>
      </nav>
    </div>
  </footer>

<script>
document.getElementById('y').textContent = new Date().getFullYear();

// === Supabase init (same as your Veo page, to avoid auth syntax issues) ===
const SUPABASE_URL = 'https://qmaealblegvcwodlmeht.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtYWVhbGJsZWd2Y3dvZGxtZWh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MjkzNzMsImV4cCI6MjA3NDIwNTM3M30.bUV6W0zBtkd_6gtfPGBSpskybUmpLC-1znljoDpYy4c';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// === Header auth UI (non-invasive) ===
const $btnLoginNav = document.getElementById('btnLoginNav');
const $btnGetStarted = document.getElementById('btnGetStarted');
const $navUser = document.getElementById('navUser');
const $navCredits = document.getElementById('navCredits');
const $navAvatar = document.getElementById('navAvatar');
const $navMenu = document.getElementById('navMenu');
const $btnLogout = document.getElementById('btnLogout');
const $navAvatarImg = document.getElementById('navAvatarImg');
function showLoggedInUI(profile, user){try{$btnLoginNav.classList.add('hidden');$btnGetStarted.classList.add('hidden');$navUser.classList.remove('hidden');$navUser.classList.add('flex');$navCredits.textContent=(profile?.credits??0)+'⚡';if(user?.user_metadata?.avatar_url){$navAvatarImg.src=user.user_metadata.avatar_url;$navAvatarImg.classList.remove('hidden');}}catch{}}
function showLoggedOutUI(){try{$btnLoginNav.classList.remove('hidden');$btnGetStarted.classList.remove('hidden');$navUser.classList.add('hidden');$navUser.classList.remove('flex');}catch{}}
$navAvatar?.addEventListener('click',()=>{const m=document.getElementById('navMenu');m.classList.toggle('hidden')});
document.addEventListener('click',(e)=>{if(!e.target.closest('#navAvatar')&&!e.target.closest('#navMenu'))document.getElementById('navMenu').classList.add('hidden')});
$btnLogout?.addEventListener('click',async()=>{await supabase.auth.signOut();showLoggedOutUI();});
async function getOrCreateProfile(user){const r=await supabase.from('profiles').select('credits').eq('user_id',user.id).maybeSingle();if(r.error)throw r.error;if(!r.data){const ins=await supabase.from('profiles').insert({user_id:user.id,email:user.email,credits:3}).select().single();if(ins.error)throw ins.error;return ins.data;}return r.data;}
(async()=>{try{const {data}=await supabase.auth.getUser();const user=data.user;if(user){try{const p=await getOrCreateProfile(user);showLoggedInUI(p,user);}catch{showLoggedOutUI();}}else{showLoggedOutUI();}}catch{}})();

// === Elements ===
const imageEl=document.getElementById('image');
const thumbsEl=document.getElementById('thumbs');
const runBtn=document.getElementById('runBtn');
const statusEl=document.getElementById('status');
const displayBox=document.getElementById('displayBox');
const previewVideo=document.getElementById('previewVideo');
const emptyHint=document.getElementById('emptyHint');

// === Query params (from Templates page) ===
const qp = new URLSearchParams(location.search);
const MOTION_ID = qp.get('motion_id') || '';
const PREVIEW   = qp.get('preview')   || '';
const NAME      = qp.get('name')      || '';
document.getElementById('tplName').textContent = NAME ? ('Template: ' + NAME) : '';

// Inject preview video if provided
(function(){
  if (!PREVIEW) return;
  emptyHint.classList.add('hidden');
  previewVideo.classList.remove('hidden');
  previewVideo.setAttribute('muted','');
  previewVideo.setAttribute('playsinline','');
  previewVideo.setAttribute('autoplay','');
  previewVideo.setAttribute('loop','');
  previewVideo.src = PREVIEW;
  previewVideo.load();
  Promise.resolve().then(()=>previewVideo.play().catch(()=>{}));
})();

// === Image preview with X ===
let __lastObjURL = null;
function clearImageSelection(){
  try { if (__lastObjURL) { URL.revokeObjectURL(__lastObjURL); __lastObjURL = null; } } catch {}
  imageEl.value = '';
  thumbsEl.innerHTML = '';
}
imageEl.addEventListener('change',()=>{
  thumbsEl.innerHTML='';
  try { if (__lastObjURL) { URL.revokeObjectURL(__lastObjURL); __lastObjURL = null; } } catch {}
  const f=imageEl.files[0];
  if(!f){ return; }
  if (f.size > 10*1024*1024){ alert('File too large (max 10MB).'); imageEl.value=''; return; }
  const u=URL.createObjectURL(f);
  __lastObjURL = u;
  const wrap = document.createElement('div');
  wrap.className = 'relative inline-block';
  const img=new Image();
  img.src=u;
  img.className='block w-full max-h-56 object-contain rounded-lg border border-white/10 bg-black/20';
  const del=document.createElement('button');
  del.type='button';
  del.className='absolute -top-2 -right-2 h-7 w-7 rounded-full bg-black/70 border border-white/20 text-white/80 hover:text-white hover:bg-black/90 flex items-center justify-center';
  del.setAttribute('aria-label','Remove image');
  del.innerHTML='&times;';
  del.onclick = clearImageSelection;
  wrap.appendChild(img); wrap.appendChild(del);
  thumbsEl.appendChild(wrap);
});

function showStatus(m,c=''){statusEl.textContent=m;statusEl.className='mt-2 text-sm '+c}

// Replace the left preview box with the result video
function showResultVideo(url, poster){
  displayBox.innerHTML='';
  const v = document.createElement('video');
  v.controls = true; v.playsInline = true; v.style.objectFit='contain';
  if (poster) v.setAttribute('poster', poster);
  v.src = url;
  v.className = 'block w-full max-h-[70vh] rounded-lg border border-white/10 bg-black/20';
  displayBox.appendChild(v);
}

// === Credits quick helpers ===
async function getCredits(){
  try{
    const ures = await supabase.auth.getUser(); const user = ures?.data?.user; if(!user) return 0;
    const { data: prof } = await supabase.from('profiles').select('credits').eq('user_id', user.id).maybeSingle();
    return prof?.credits ?? 0;
  }catch{return 0;}
}

// === Run job ===
async function runJob(){
  try{
    const { data: authData } = await supabase.auth.getUser();
    if(!authData.user){ alert('Please log in or register first.'); return; }

    const cost = 5;
    const credits = await getCredits();
    if (credits < cost){ showStatus('Not enough credits (need 5).','text-rose-300'); return; }

    const f = imageEl.files[0];
    if (!f){ showStatus('Please select one image.','text-rose-300'); return; }
    if (!MOTION_ID){ showStatus('Missing motion_id','text-rose-300'); return; }

    displayBox.innerHTML = '<span class="text-xs text-zinc-500 animate-pulse py-16">Generating… this can take up to 2–5 minutes.</span>';
    showStatus('Uploading image…','text-zinc-400');

    const uid = authData.user.id;
    const fd = new FormData();
    fd.append('file', f, f.name || 'image.png');
    const ur = await fetch('/.netlify/functions/kie-upload',{ method:'POST', headers:{'X-USER-ID': uid}, body: fd });
    const uj = await ur.json().catch(()=>null);
    if (!ur.ok || !uj || !uj.downloadUrl) { showStatus('Upload failed','text-rose-300'); return; }
    const imageUrl = uj.downloadUrl;

    showStatus('Submitting job… (deducting 5⚡)','text-zinc-400');

    const payload = {
      uid,
      motion_id: MOTION_ID,
      prompt: (document.getElementById('prompt').value || '').trim(),
      imageUrl
    };

    const r = await fetch('/.netlify/functions/run-higgsfield', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-USER-ID': uid },
      body: JSON.stringify(payload)
    });
    const j = await r.json().catch(()=>({}));
    if (!r.ok || !j.submitted){
      showStatus('Submit failed: ' + (j.error || r.status), 'text-rose-300'); return;
    }

    showStatus('✅ Submitted. Waiting for result…','text-emerald-300');
    await pollResult(j.taskId || j.run_id || j.requestId, uid);
  } catch (e){
    showStatus('❌ ' + (e.message || String(e)), 'text-rose-300');
  }
}

async function pollResult(taskId, uid){
  for (let i=0;i<180;i++){
    try{
      const r = await fetch('/.netlify/functions/hf-check?taskId=' + encodeURIComponent(taskId) + '&uid=' + encodeURIComponent(uid));
      const j = await r.json().catch(()=>({}));
      if (j && j.ok && j.video_url){
        showResultVideo(j.video_url, j.thumb_url || '');
        showStatus('Done.','text-emerald-300');
        return;
      }
    }catch{}
    await new Promise(s=>setTimeout(s,1500));
  }
  showStatus('Still processing… try refreshing later','text-yellow-300');
}

document.getElementById('runBtn').addEventListener('click', runJob);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HANSORA • Midjourney (Image → Video)</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%235b5ce2'/%3E%3Ctext x='50' y='60' font-size='54' text-anchor='middle' fill='white' font-family='Arial'%3EH%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --base-bg:#0b0d13; --base-line:#1a1f2b; --brand:#6366f1; }
    body{background:radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.15), transparent 60%),
                       radial-gradient(1200px 600px at 100% 100%, rgba(56,189,248,.12), transparent 60%),
                       var(--base-bg); color:#e5e7eb}
    .bg-base-bg{background:var(--base-bg)}
    .border-base-line{border-color:var(--base-line)}
    .btn{border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.06)}
    .btn:hover{background:rgba(255,255,255,.1)}
    .btn-brand{background:var(--brand); border-color:transparent; color:white}
    .btn-brand:hover{background:#7c7ff6}
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .input-dark{background:rgba(255,255,255,.05)!important;color:#e5e7eb!important;border:1px solid rgba(255,255,255,.12)!important}
    .input-dark::placeholder{color:#9ca3af}
    select.input-dark option{background:#0b0d13;color:#e5e7eb}
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-40 border-b border-base-line/60 bg-base-bg/70 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-3 hover:opacity-90">
        <div class="h-9 w-9 rounded-full bg-white/10 flex items-center justify-center font-bold">H</div>
        <span class="font-semibold tracking-wide">HANSORA AI</span>
      </a>
      <nav class="hidden md:flex items-center gap-8 text-sm">
        <a href="index.html#models" class="hover:text-white/90">Models</a>
        <a href="index.html#templates" class="hover:text-white/90">Templates</a>
        <a href="index.html#pricing" class="hover:text-white/90">Pricing</a>
        <a href="index.html#faq" class="hover:text-white/90">FAQ</a>
      </nav>
      <div class="flex items-center gap-3">
        <a id="btnLoginNav" href="index.html#login" class="rounded-xl btn px-3 py-2 text-sm">Log in</a>
        <a id="btnGetStarted" href="index.html#login" class="rounded-xl btn-brand px-3 py-2 text-sm font-semibold shadow-soft">Get Started</a>
        <div id="navUser" class="hidden items-center gap-2">
          <span id="navCredits" class="text-sm text-white/80 mr-2">0⚡</span>
          <div class="relative">
            <button id="navAvatar" class="h-9 w-9 rounded-full bg-white/10 border border-white/10 overflow-hidden"></button>
            <div id="navMenu" class="absolute right-0 mt-2 w-48 rounded-xl border border-white/10 bg-base-bg shadow-soft p-1 text-sm hidden">
              <a href="usage.html" class="block rounded-lg px-3 py-2 hover:bg-white/5">Usage</a>
              <a href="index.html#pricing" class="block rounded-lg px-3 py-2 hover:bg-white/5">Subscriptions</a>
              <button id="btnLogout" class="w-full text-left rounded-lg px-3 py-2 hover:bg-white/5">Log out</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
    <div class="grid md:grid-cols-2 gap-6 items-start">
      <!-- Left: form -->
      <div class="rounded-2xl p-5 border border-white/10 shadow-soft bg-white/5">
        <h1 class="text-2xl font-bold">Midjourney — Image → Video <span class="text-xs text-zinc-400 align-middle">(≈5s)</span></h1>
        <p class="mt-1 text-sm text-zinc-400">Upload <b>1 image</b> and write your prompt. Output: MP4.</p>

        <div class="mt-4 space-y-3">
          <div>
            <label class="text-xs text-zinc-400">Select image (jpeg/png/webp, ≤10MB)</label>
            <input id="image" type="file" accept="image/*" class="mt-1 w-full rounded-lg border border-white/10 bg-white/5 px-3 py-2 outline-none"/>
            <div id="thumbs" class="mt-2 flex gap-2 flex-wrap"></div>
          </div>

          <div>
            <label class="text-xs text-zinc-400">Aspect ratio</label>
            <select id="ratio" class="mt-1 w-full rounded-lg border border-white/10 bg-base-bg/60 px-3 py-2 outline-none input-dark">
              <option value="1:1" selected>1:1</option>
              <option value="2:3">2:3 (portrait)</option>
              <option value="3:2">3:2 (landscape)</option>
              <option value="9:16">9:16 (vertical)</option>
              <option value="16:9">16:9 (wide)</option>
            </select>
          </div>

          <div>
            <label class="text-xs text-zinc-400">Prompt</label>
            <textarea id="prompt" placeholder="Describe motion, camera, mood…" class="mt-1 w-full rounded-lg border border-white/10 bg-base-bg/60 px-3 py-2 outline-none min-h-[120px] input-dark"></textarea>
          </div>

          <button id="runBtn" type="button" class="w-full rounded-xl btn-brand px-4 py-3 font-semibold" onclick="__run()" disabled>Run (cost: 2⚡)</button>
          <div id="status" class="mt-2 text-sm"></div>
        </div>
      </div>

      <!-- Right: result -->
      <div class="rounded-2xl p-5 border border-white/10 shadow-soft bg-white/5">
        <h3 class="text-lg font-semibold">Result</h3>
        <p class="text-xs text-zinc-400">Your video will appear below.</p>
        <div id="resultBox" class="mt-3 w-full rounded-xl border border-white/10 bg-base-bg/60 flex items-center justify-center min-h-[220px]">
          <span class="text-xs text-zinc-500">No result yet</span>
        </div>
        <div class="mt-3 flex items-center gap-3">
          <button id="playBtn" class="hidden rounded-xl btn px-4 py-2 text-sm">Play</button>
          <a id="downloadLink" href="#" class="hidden rounded-xl btn px-4 py-2 text-sm">Download</a>
        </div>
      </div>
    </div>
  </section>

  <footer class="border-t border-base-line/60">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10 text-sm text-zinc-400 flex flex-col sm:flex-row items-center justify-between gap-4">
      <p>© <span id="y"></span> HANSORA AI — All rights reserved.</p>
      <nav class="flex items-center gap-5">
        <a href="index.html#terms" class="hover:text-white/80">Terms</a>
        <a href="index.html#privacy" class="hover:text-white/80">Privacy</a>
        <a href="index.html#contact" class="hover:text-white/80">Contact</a>
      </nav>
    </div>
  </footer>

<script>
document.getElementById('y').textContent = new Date().getFullYear();
window.__MJ_BUSY = false;

// Supabase init (same as Veo page)
const SUPABASE_URL = 'https://qmaealblegvcwodlmeht.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtYWVhbGJsZWd2Y3dvZGxtZWh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MjkzNzMsImV4cCI6MjA3NDIwNTM3M30.bUV6W0zBtkd_6gtfPGBSpskybUmpLC-1znljoDpYy4c';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Header: basic auth UI
const $btnLoginNav = document.getElementById('btnLoginNav');
const $btnGetStarted = document.getElementById('btnGetStarted');
const $navUser = document.getElementById('navUser');
const $navCredits = document.getElementById('navCredits');
const $btnLogout = document.getElementById('btnLogout');
function showLoggedInUI(){ $btnLoginNav.classList.add('hidden'); $btnGetStarted.classList.add('hidden'); $navUser.classList.remove('hidden'); $navUser.classList.add('flex'); }
function showLoggedOutUI(){ $btnLoginNav.classList.remove('hidden'); $btnGetStarted.classList.remove('hidden'); $navUser.classList.add('hidden'); $navUser.classList.remove('flex'); }
$btnLogout?.addEventListener('click', async ()=>{ await supabase.auth.signOut(); showLoggedOutUI(); });
(async()=>{
  const {data}=await supabase.auth.getUser(); const user=data.user;
  if (user) {
    try{
      const r=await supabase.from('profiles').select('credits').eq('user_id',user.id).maybeSingle();
      $navCredits.textContent=(r.data?.credits??0)+'⚡';
      showLoggedInUI();
    }catch{ showLoggedInUI(); }
  } else showLoggedOutUI();
})();

// Elements
const imageEl=document.getElementById('image');
const thumbsEl=document.getElementById('thumbs');
const ratioEl=document.getElementById('ratio');
const promptEl=document.getElementById('prompt');
const runBtn=document.getElementById('runBtn');
const statusEl=document.getElementById('status');
const resultBox=document.getElementById('resultBox');
const downloadLink=document.getElementById('downloadLink');

// Cost fixed at 2⚡
function currentCost(){ return 2; }
function repaintCost(){ runBtn.textContent = 'Run (cost: ' + currentCost() + '⚡)'; }
repaintCost();

// Image preview (single)
let __lastObjURL=null;
function clearImageSelection(){
  try{ if(__lastObjURL){ URL.revokeObjectURL(__lastObjURL); __lastObjURL=null; } }catch{}
  imageEl.value=''; thumbsEl.innerHTML='';
}
imageEl.addEventListener('change',()=>{
  thumbsEl.innerHTML='';
  try{ if(__lastObjURL){ URL.revokeObjectURL(__lastObjURL); __lastObjURL=null; } }catch{}
  const f=imageEl.files[0]; if(!f) return;
  const u=URL.createObjectURL(f); __lastObjURL=u;
  const img=new Image(); img.src=u;
  img.className='block w-full max-h-56 object-contain rounded-lg border border-white/10 bg-black/20';
  const wrap=document.createElement('div'); wrap.className='relative inline-block';
  const del=document.createElement('button'); del.type='button';
  del.className='absolute -top-2 -right-2 h-7 w-7 rounded-full bg-black/70 border border-white/20 text-white/80 hover:text-white hover:bg-black/90 flex items-center justify-center';
  del.innerHTML='&times;'; del.onclick=clearImageSelection; wrap.appendChild(img); wrap.appendChild(del);
  thumbsEl.appendChild(wrap);
});

function showStatus(m,c=''){ statusEl.textContent=m; statusEl.className='mt-2 text-sm '+c; }

function showVideo(url, poster){
  resultBox.innerHTML='';
  const v=document.createElement('video');
  v.controls=true; v.playsInline=true; v.src=url;
  if(poster) v.setAttribute('poster',poster);
  v.className='block w-full max-h-[70vh] rounded-lg border border-white/10 bg-black/20';
  resultBox.appendChild(v);
  downloadLink.href='/.netlify/functions/download-proxy?url='+encodeURIComponent(url)+'&name='+encodeURIComponent('mj-video.mp4');
  downloadLink.classList.remove('hidden');
}

// Live credits refresh + guard like Veo page
async function getCredits(){
  try{ const {data}=await supabase.auth.getUser(); const user=data?.user; if(!user) return 0;
       const r=await supabase.from('profiles').select('credits').eq('user_id',user.id).maybeSingle();
       return r.data?.credits ?? 0; }catch{ return 0; }
}
async function chargeCredits(cost){
  const {data}=await supabase.auth.getUser(); const user=data?.user; if(!user) return;
  const r=await supabase.from('profiles').select('credits').eq('user_id',user.id).maybeSingle();
  const cur=r.data?.credits ?? 0; if(cur<cost) throw new Error('Not enough credits (need '+cost+').');
  await supabase.from('profiles').update({credits:cur-cost}).eq('user_id',user.id);
}
async function refreshCreditsUI(){
  try{
    const c=await getCredits();
    const nav=document.getElementById('navCredits'); if(nav) nav.textContent=(c??0)+'⚡';
    if(!window.__MJ_BUSY) runBtn.disabled=false;
    runBtn.classList.toggle('opacity-50', false);
    runBtn.classList.toggle('cursor-not-allowed', false);
  }catch{}
}
refreshCreditsUI();

// Poll mjv-check until mp4
async function mjvCheckPoll(taskId, uid, rid){
  for(let i=0;i<120;i++){
    try{
      const r = await fetch('/.netlify/functions/mjv-check?taskId='+encodeURIComponent(taskId)+'&uid='+encodeURIComponent(uid)+'&run_id='+encodeURIComponent(rid));
      const j = await r.json().catch(()=>({}));
      if(j && j.ok && j.video_url){
        showVideo(j.video_url, j.thumb_url || '');
        showStatus('✅ Done.', 'text-emerald-300'); window.__MJ_BUSY=false; runBtn.disabled=false; repaintCost();
        return;
      }
    }catch{}
    await new Promise(r=>setTimeout(r,1500));
  }
  showStatus('Still processing… try refreshing later', 'text-yellow-300');
  window.__MJ_BUSY=false; runBtn.disabled=false; repaintCost();
}

// Main run
window.__run = async function(){
  const {data:authData}=await supabase.auth.getUser();
  if(!authData.user){ alert('Please log in or register first.'); return; }

  // Validate: MUST have both image AND prompt (your rule)
  const files=[...imageEl.files].slice(0,1);
  const hasImage = files.length===1;
  const _prompt = (promptEl.value||'').trim();
  if(!hasImage || !_prompt){
    showStatus('Please upload 1 image and enter a prompt (both required).','text-rose-300');
    return;
  }
  // Size check
  if(files[0].size>10*1024*1024){ alert('File too large: '+files[0].name); return; }

  // Credits guard
  const cost=currentCost();
  try{
    const bal=await getCredits();
    if(bal<cost){ showStatus('Not enough credits (need '+cost+').','text-rose-300'); return; }
  }catch{}

  window.__MJ_BUSY=true; runBtn.disabled=true; runBtn.textContent='Working…';
  showStatus('Submitting…','text-zinc-400');
  resultBox.innerHTML='<span class="text-xs text-zinc-500 animate-pulse">Generating…</span>';

  try{
    const uid=authData.user.id;
    const aspectRatio=ratioEl.value || '1:1';

    // Upload image via kie-upload
    const fd=new FormData();
    fd.append('file', files[0], files[0].name || 'image.png');
    const ur=await fetch('/.netlify/functions/kie-upload',{method:'POST',headers:{'X-USER-ID':uid},body:fd});
    const uj=await ur.json().catch(()=>null);
    if(!ur.ok || !uj || !uj.downloadUrl) throw new Error(uj?.error || 'Upload failed');
    const imageUrl=uj.downloadUrl;

    // Create MJ job
    const resp=await fetch('/.netlify/functions/run-mj-video',{
      method:'POST',
      headers:{'Content-Type':'application/json','X-USER-ID':uid},
      body:JSON.stringify({ uid, prompt:_prompt, imageUrl, aspectRatio })
    });
    const j=await resp.json().catch(()=>({}));
    if(!resp.ok || !j.submitted){
      showStatus('Error submitting: '+(j.error || resp.status),'text-rose-300'); runBtn.disabled=false; repaintCost(); return;
    }

    // Debit (client-side)
    try{ await chargeCredits(cost); await refreshCreditsUI(); }catch{}

    const taskId=j.taskId || ''; const run_id=j.run_id || '';
    showStatus('✅ Submitted. Waiting for result…','text-emerald-300');
    if(taskId && run_id) mjvCheckPoll(taskId, uid, run_id);
  }catch(e){
    showStatus('❌ '+(e.message||String(e)),'text-rose-300'); window.__MJ_BUSY=false; runBtn.disabled=false; repaintCost();
  }
};

// Realtime credits listener (same pattern as Veo page)
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(async function(){
    try{
      const { data: userData } = await supabase.auth.getUser();
      const user = userData?.user; if(!user) return;
      async function __refresh(){ try{
        const { data: prof } = await supabase.from('profiles').select('credits').eq('user_id', user.id).maybeSingle();
        const c = prof?.credits ?? 0;
        const nav=document.getElementById('navCredits'); if(nav) nav.textContent=(c??0)+'⚡';
        if(!window.__MJ_BUSY) runBtn.disabled=false; return c;
      }catch{return null;} }
      await __refresh();
      supabase.channel('credits_live_'+user.id)
        .on('postgres_changes', {event:'UPDATE',schema:'public',table:'profiles',filter:'user_id=eq.'+user.id}, __refresh)
        .subscribe();
      const orig=window.__run;
      window.__run=async function(){
        try{
          const c=await __refresh();
          if(c!==null && c<currentCost()){ showStatus('Not enough credits (need '+currentCost()+').','text-rose-300'); return; }
        }catch{}
        const r=await orig(); const id=setInterval(__refresh,1500); setTimeout(()=>clearInterval(id),15000); return r;
      };
    }catch{}
  });
})();
</script>
</body>
</html>
